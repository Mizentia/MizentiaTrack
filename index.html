<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ফিনান্স ট্র্যাকার</title>
    <style>
        :root {
            --bg-dark: #020617;
            --bg-card: #0f172a;
            --bg-card-hover: #1e293b;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --border: #1e293b;
            --radius: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* Layout */
        .app-container { display: flex; height: 100vh; flex-direction: column; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        
        /* Sidebar / Navbar */
        .sidebar { 
            display: none; width: 260px; background: var(--bg-card); 
            border-right: 1px solid var(--border); padding: 20px; 
            flex-direction: column; height: 100%;
        }
        .mobile-nav {
            display: flex; justify-content: space-around; background: rgba(15, 23, 42, 0.95);
            padding: 10px; position: fixed; bottom: 0; left: 0; right: 0; 
            border-top: 1px solid var(--border); backdrop-filter: blur(10px); z-index: 100;
        }

        /* Desktop View */
        @media (min-width: 768px) {
            .app-container { flex-direction: row; }
            .sidebar { display: flex; }
            .mobile-nav { display: none; }
            .main-content { padding: 40px; }
        }

        /* Typography */
        h1 { font-size: 24px; font-weight: 700; background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; color: transparent; margin-bottom: 5px; }
        h2 { font-size: 20px; font-weight: 600; margin-bottom: 10px; }
        h3 { font-size: 16px; font-weight: 600; }
        p { font-size: 14px; color: var(--text-muted); }

        /* Components */
        .card { 
            background: var(--bg-card); border: 1px solid var(--border); 
            border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
            box-shadow: var(--shadow); transition: transform 0.2s, border-color 0.2s;
        }
        .card:hover { border-color: #312e81; }

        .btn {
            padding: 10px 20px; border-radius: 50px; border: none; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;
            transition: all 0.2s; outline: none;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-card-hover); color: var(--text-muted); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); color: white; }
        .btn-danger { color: var(--text-muted); background: transparent; padding: 8px; }
        .btn-danger:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .btn-icon { padding: 8px; border-radius: 50%; background: transparent; color: var(--text-muted); border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon:hover { color: white; background: var(--bg-card-hover); }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
        .input-field {
            width: 100%; background: #020617; border: 1px solid var(--border);
            padding: 12px; border-radius: 12px; color: white; outline: none;
            font-size: 14px; transition: border-color 0.2s;
        }
        .input-field:focus { border-color: var(--primary); }

        /* Grid Layouts */
        .grid-3 { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) {
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-2 { grid-template-columns: repeat(2, 1fr); }
        }

        /* Nav Items */
        .nav-btn {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            width: 100%; text-align: left; background: transparent; border: none;
            color: var(--text-muted); border-radius: 12px; cursor: pointer; margin-bottom: 5px;
            transition: all 0.2s;
        }
        .nav-btn.active { background: rgba(79, 70, 229, 0.1); color: #818cf8; }
        .nav-btn:hover:not(.active) { background: var(--bg-card-hover); color: white; }

        .mobile-nav-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            background: transparent; border: none; color: var(--text-muted); cursor: pointer; gap: 4px;
        }
        .mobile-nav-btn.active { color: #818cf8; }
        .mobile-nav-btn span { font-size: 10px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: var(--bg-card); width: 90%; max-width: 450px;
            border-radius: 24px; border: 1px solid var(--border); overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; }

        /* Specific Elements */
        .balance-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; padding: 24px; border-radius: 24px; position: relative; overflow: hidden;
        }
        .balance-card::after {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background: rgba(255,255,255,0.1); border-radius: 50%; filter: blur(40px);
        }
        
        .progress-bar { width: 100%; height: 10px; background: #1e293b; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #6366f1); transition: width 1s ease-out; }
        
        .transaction-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid var(--border);
        }
        .transaction-item:last-child { border-bottom: none; }
        
        .icon-box {
            width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
        }
        .icon-income { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .icon-expense { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; background: #1e293b; color: var(--text-muted); border: 1px solid var(--border); }
        
        /* Helpers */
        .hide-mobile { display: none; }
        @media (min-width: 768px) { .hide-mobile { display: inline; } }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-muted { color: var(--text-muted); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-in { animation: slideUp 0.4s ease-out forwards; }
        .spin { animation: spin 1s linear infinite; transform-origin: center; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Login Screen */
        .login-container {
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
            background: radial-gradient(circle at top center, #1e1b4b 0%, #020617 100%);
        }
        .login-box {
            width: 100%; max-width: 400px; background: var(--bg-card); padding: 40px; 
            border-radius: 24px; border: 1px solid var(--border); text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, 
            query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAO7EN4wU33v028vd9pelSyhGibSNGQLU0",
            authDomain: "mizentiatrack.firebaseapp.com",
            projectId: "mizentiatrack",
            storageBucket: "mizentiatrack.firebasestorage.app",
            messagingSenderId: "1009510331718",
            appId: "1:1009510331718:web:e8cb1f5acd04a6a5aca147"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'finance-tracker-app'; // App Scope

        // --- Icons (SVG Strings) ---
        const Icons = {
            Pie: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>`,
            Dashboard: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`,
            Wallet: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>`,
            Target: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
            Exchange: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>`,
            Plus: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
            Logout: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>`,
            Up: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>`,
            Down: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>`,
            Trash: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
            Edit: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>`,
            Calendar: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            Search: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            Close: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            Key: `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></svg>`,
            Login: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>`,
            Loader: `<svg class="spin" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`,
            Cash: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>`,
            Card: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>`
        };

        // --- State Management ---
        const state = {
            accessKey: localStorage.getItem('finance_access_key') || '',
            activeTab: 'dashboard',
            isFirebaseReady: false,
            accounts: [],
            goals: [],
            transactions: [],
            loading: false,
            modals: { active: null, data: null }, // active: 'transaction' | 'account' | 'goal'
            listeners: [] // To store unsubscribe functions
        };

        // --- Utils ---
        const formatCurrency = (amount) => new Intl.NumberFormat('bn-BD', { style: 'currency', currency: 'BDT' }).format(amount);
        const formatDate = (dateString) => {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        // --- Application Logic ---

        // 1. Initialize Auth
        signInAnonymously(auth).catch(console.error);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.isFirebaseReady = true;
                renderApp();
            }
        });

        // 2. Data Subscription
        function subscribeToData() {
            // Clear old listeners
            state.listeners.forEach(unsub => unsub());
            state.listeners = [];

            if (!state.accessKey || !state.isFirebaseReady) return;

            state.loading = true;
            renderApp();

            const userPath = `users/${state.accessKey}`;
            
            // Accounts
            const unsubAcc = onSnapshot(collection(db, 'artifacts', appId, userPath, 'accounts'), (snap) => {
                state.accounts = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
                state.loading = false;
                renderApp();
            });

            // Goals
            const unsubGoal = onSnapshot(collection(db, 'artifacts', appId, userPath, 'goals'), (snap) => {
                state.goals = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
                renderApp();
            });

            // Transactions
            const unsubTrans = onSnapshot(query(collection(db, 'artifacts', appId, userPath, 'transactions'), orderBy("date", "desc")), (snap) => {
                state.transactions = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
                state.loading = false;
                renderApp();
            });

            state.listeners.push(unsubAcc, unsubGoal, unsubTrans);
        }

        // 3. Actions
        window.actions = {
            login: (e) => {
                e.preventDefault();
                const input = document.getElementById('loginKey').value;
                if (!input.trim()) return;
                const cleanKey = input.trim().replace(/\s+/g, '-').toLowerCase();
                localStorage.setItem('finance_access_key', cleanKey);
                state.accessKey = cleanKey;
                subscribeToData();
            },
            logout: () => {
                if(confirm("লগআউট করতে চান?")) {
                    localStorage.removeItem('finance_access_key');
                    state.accessKey = '';
                    state.accounts = [];
                    state.goals = [];
                    state.transactions = [];
                    state.listeners.forEach(u => u());
                    state.listeners = [];
                    renderApp();
                }
            },
            setTab: (tab) => {
                state.activeTab = tab;
                renderApp();
            },
            openModal: (type, dataId = null) => {
                const data = dataId 
                    ? (type === 'account' ? state.accounts : type === 'goal' ? state.goals : state.transactions).find(i => i.id === dataId)
                    : null;
                state.modals = { active: type, data: data };
                renderApp();
            },
            closeModal: () => {
                state.modals = { active: null, data: null };
                renderApp();
            },
            deleteItem: async (type, id) => {
                if(!confirm('মুছে ফেলতে চান?')) return;
                const path = `users/${state.accessKey}`;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, path, type === 'acc' ? 'accounts' : type === 'goal' ? 'goals' : 'transactions', id));
                } catch(e) { console.error(e); }
            },
            saveTransaction: async (e) => {
                e.preventDefault();
                const form = e.target;
                const type = form.type.value; // handled by custom buttons visually, but let's grab hidden input
                const amount = Number(form.amount.value);
                const accountId = form.accountId.value;
                
                const newTrans = {
                    type: document.getElementById('transTypeIncome').classList.contains('active') ? 'income' : 'expense',
                    amount: amount,
                    accountId: accountId,
                    category: form.category.value,
                    date: form.date.value,
                    description: form.description.value
                };

                const userPath = `users/${state.accessKey}`;
                await addDoc(collection(db, 'artifacts', appId, userPath, 'transactions'), { ...newTrans, createdAt: serverTimestamp() });
                
                // Balance Update
                const accRef = doc(db, 'artifacts', appId, userPath, 'accounts', accountId);
                const acc = state.accounts.find(a => a.id === accountId);
                if(acc) {
                    const newBal = newTrans.type === 'income' ? Number(acc.balance) + amount : Number(acc.balance) - amount;
                    await updateDoc(accRef, { balance: newBal });
                }
                actions.closeModal();
            },
            saveAccount: async (e) => {
                e.preventDefault();
                const form = e.target;
                const data = { name: form.name.value, type: form.type.value, balance: Number(form.balance.value) };
                const userPath = `users/${state.accessKey}`;
                
                if (state.modals.data) {
                    await updateDoc(doc(db, 'artifacts', appId, userPath, 'accounts', state.modals.data.id), data);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, userPath, 'accounts'), data);
                }
                actions.closeModal();
            },
            saveGoal: async (e) => {
                e.preventDefault();
                const form = e.target;
                const data = { icon: form.icon.value, title: form.title.value, target: Number(form.target.value), deadline: form.deadline.value };
                const userPath = `users/${state.accessKey}`;
                
                if (state.modals.data) {
                    await updateDoc(doc(db, 'artifacts', appId, userPath, 'goals', state.modals.data.id), data);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, userPath, 'goals'), data);
                }
                actions.closeModal();
            },
            toggleTransType: (type) => {
                const incBtn = document.getElementById('transTypeIncome');
                const expBtn = document.getElementById('transTypeExpense');
                if(type === 'income') {
                    incBtn.style.background = 'var(--success)'; incBtn.style.color = 'white'; incBtn.classList.add('active');
                    expBtn.style.background = 'transparent'; expBtn.style.color = 'var(--text-muted)'; expBtn.classList.remove('active');
                } else {
                    expBtn.style.background = 'var(--danger)'; expBtn.style.color = 'white'; expBtn.classList.add('active');
                    incBtn.style.background = 'transparent'; incBtn.style.color = 'var(--text-muted)'; incBtn.classList.remove('active');
                }
            },
            filterTrans: (val) => {
                const rows = document.querySelectorAll('.trans-row');
                rows.forEach(row => {
                    const text = row.dataset.search.toLowerCase();
                    row.style.display = text.includes(val.toLowerCase()) ? '' : 'none';
                });
            }
        };

        // --- Rendering ---
        const root = document.getElementById('root');

        function renderApp() {
            if (!state.accessKey) {
                root.innerHTML = renderLogin();
                return;
            }

            if (state.loading && state.accounts.length === 0) {
                root.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; color:#818cf8;">${Icons.Loader}<p style="margin-top:20px">ডাটা লোড হচ্ছে...</p></div>`;
                return;
            }

            // Calculations
            const totalBalance = state.accounts.reduce((sum, acc) => sum + Number(acc.balance), 0);
            const totalIncome = state.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Number(t.amount), 0);
            const totalExpense = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Number(t.amount), 0);

            let mainContent = '';
            if (state.activeTab === 'dashboard') mainContent = renderDashboard(totalBalance, totalIncome, totalExpense);
            else if (state.activeTab === 'accounts') mainContent = renderAccounts();
            else if (state.activeTab === 'goals') mainContent = renderGoals(totalBalance);
            else if (state.activeTab === 'transactions') mainContent = renderTransactions();

            root.innerHTML = `
                <div class="app-container">
                    <aside class="sidebar">
                        <div style="display:flex; alignItems:center; gap:10px; marginBottom:40px">
                            <div style="background:#4f46e5; padding:8px; border-radius:8px; display:flex; color:white">${Icons.Pie}</div>
                            <span style="font-weight:bold; font-size:20px">MoneyTrack</span>
                        </div>
                        <nav style="flex:1">
                            ${renderNavBtn('dashboard', Icons.Dashboard, 'ড্যাশবোর্ড')}
                            ${renderNavBtn('accounts', Icons.Wallet, 'অ্যাকাউন্ট')}
                            ${renderNavBtn('goals', Icons.Target, 'লক্ষ্য (Goals)')}
                            ${renderNavBtn('transactions', Icons.Exchange, 'লেনদেন')}
                        </nav>
                    </aside>

                    <main class="main-content">
                        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap; gap:15px">
                            <div>
                                <h1>ফিনান্স ট্র্যাকার</h1>
                                <div style="display:flex; align-items:center; gap:8px; margin-top:5px">
                                    <span style="width:8px; height:8px; border-radius:50%; background:#10b981"></span>
                                    <p style="margin:0; font-size:12px">আইডি: <span style="color:#818cf8; font-family:monospace">${state.accessKey}</span></p>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px">
                                <button class="btn btn-secondary" onclick="actions.logout()">
                                    ${Icons.Logout} <span class="hide-mobile">চেঞ্জ আইডি</span>
                                </button>
                                <button class="btn btn-primary" onclick="actions.openModal('transaction')">
                                    ${Icons.Plus} <span class="hide-mobile">লেনদেন যুক্ত করুন</span>
                                </button>
                            </div>
                        </header>
                        
                        <div class="animate-in">
                            ${mainContent}
                        </div>
                    </main>

                    <div class="mobile-nav">
                        ${renderMobileBtn('dashboard', Icons.Dashboard, 'Home')}
                        ${renderMobileBtn('accounts', Icons.Wallet, 'Acc')}
                        ${renderMobileBtn('goals', Icons.Target, 'Goals')}
                        ${renderMobileBtn('transactions', Icons.Exchange, 'Trans')}
                    </div>

                    ${renderModals()}
                </div>
            `;
        }

        // --- View Helpers ---
        function renderNavBtn(id, icon, label) {
            return `<button class="nav-btn ${state.activeTab === id ? 'active' : ''}" onclick="actions.setTab('${id}')">${icon} <span>${label}</span></button>`;
        }
        function renderMobileBtn(id, icon, label) {
            return `<button class="mobile-nav-btn ${state.activeTab === id ? 'active' : ''}" onclick="actions.setTab('${id}')">${icon} <span>${label}</span></button>`;
        }

        function renderLogin() {
            return `
                <div class="login-container">
                    <div class="login-box animate-in">
                        <div style="display:inline-block; padding:15px; background:#1e293b; border-radius:20px; margin-bottom:20px; color:#818cf8">
                            ${Icons.Key}
                        </div>
                        <h1>ফিনান্স ট্র্যাকার</h1>
                        <p style="margin-bottom:30px">আপনার সিক্রেট আইডি দিয়ে প্রবেশ করুন</p>
                        <form onsubmit="actions.login(event)">
                            <div class="input-group">
                                <input id="loginKey" class="input-field" style="text-align:center; font-size:18px; font-family:monospace" placeholder="rakib-wallet" required />
                            </div>
                            <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center" ${!state.isFirebaseReady ? 'disabled' : ''}>
                                ${!state.isFirebaseReady ? Icons.Loader + ' কানেক্ট হচ্ছে...' : Icons.Login + ' প্রবেশ করুন'}
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderDashboard(bal, inc, exp) {
            const recent = state.transactions.slice(0, 5).map(t => renderTransactionRow(t)).join('');
            const goalsList = state.goals.slice(0, 3).map(g => renderGoalItem(g, bal)).join('');
            
            return `
                <div style="display:flex; flex-direction:column; gap:25px">
                    <div class="grid-3">
                        <div class="balance-card">
                            <p style="color:#c7d2fe; margin-bottom:5px">মোট ব্যালেন্স</p>
                            <h2 style="font-size:32px">${formatCurrency(bal)}</h2>
                            <div style="margin-top:15px; display:flex; align-items:center; gap:5px; font-size:12px; background:rgba(255,255,255,0.1); width:fit-content; padding:4px 10px; border-radius:20px">
                                ${Icons.Wallet} ${state.accounts.length} টি অ্যাকাউন্ট
                            </div>
                        </div>
                        <div class="card" style="display:flex; flex-direction:column; justify-content:center">
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
                                <div class="icon-box icon-income">${Icons.Up}</div> <p>মোট আয়</p>
                            </div>
                            <h2 style="color:#f8fafc">${formatCurrency(inc)}</h2>
                        </div>
                        <div class="card" style="display:flex; flex-direction:column; justify-content:center">
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
                                <div class="icon-box icon-expense">${Icons.Down}</div> <p>মোট ব্যয়</p>
                            </div>
                            <h2 style="color:#f8fafc">${formatCurrency(exp)}</h2>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <h3>সাম্প্রতিক লেনদেন</h3>
                            <div style="margin-top:15px">
                                ${recent || '<p style="text-align:center; padding:20px">কোন লেনদেন নেই</p>'}
                            </div>
                        </div>
                        <div class="card">
                            <h3>লক্ষ্য (Goals)</h3>
                            <div style="margin-top:15px; display:flex; flex-direction:column; gap:15px">
                                ${goalsList || '<p style="text-align:center; padding:20px">কোন গোল সেট করা নেই</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAccounts() {
            const list = state.accounts.map(acc => `
                <div class="card" style="position:relative; overflow:hidden">
                    <div style="position:absolute; left:0; top:0; bottom:0; width:4px; background:linear-gradient(to bottom, #4f46e5, #ec4899)"></div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-start">
                        <div style="display:flex; gap:12px">
                            <div style="background:#1e293b; padding:10px; border-radius:10px; color:#94a3b8">
                                ${acc.type === 'cash' ? Icons.Cash : acc.type === 'bank' ? Icons.Card : Icons.Wallet}
                            </div>
                            <div>
                                <div style="font-weight:bold; font-size:16px">${acc.name}</div>
                                <div style="font-size:11px; text-transform:uppercase; color:var(--text-muted); margin-top:2px">${acc.type}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:5px">
                            <button class="btn-icon" onclick="actions.openModal('account', '${acc.id}')">${Icons.Edit}</button>
                            <button class="btn-icon" onclick="actions.deleteItem('acc', '${acc.id}')" style="color:#ef4444">${Icons.Trash}</button>
                        </div>
                    </div>
                    <div style="margin-top:20px">
                        <p>বর্তমান ব্যালেন্স</p>
                        <h2 style="color:white">${formatCurrency(acc.balance)}</h2>
                    </div>
                </div>
            `).join('');

            return `
                <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                    <h2>আমার অ্যাকাউন্টস</h2>
                    <button class="btn btn-primary" onclick="actions.openModal('account')">${Icons.Plus} নতুন</button>
                </div>
                <div class="grid-3">${list}</div>
            `;
        }

        function renderGoals(bal) {
            const list = state.goals.map(g => renderGoalItem(g, bal, true)).join('');
            return `
                <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                    <h2>সেভিংস গোলস</h2>
                    <button class="btn btn-primary" onclick="actions.openModal('goal')">${Icons.Plus} নতুন গোল</button>
                </div>
                <div class="grid-2">${list}</div>
            `;
        }

        function renderGoalItem(goal, bal, showActions = false) {
            const percent = Math.min(100, Math.round((bal / goal.target) * 100));
            const remaining = Math.max(0, goal.target - bal);
            const actionsHtml = showActions ? `
                <div style="display:flex; gap:5px">
                    <button class="btn-icon" onclick="actions.openModal('goal', '${goal.id}')">${Icons.Edit}</button>
                    <button class="btn-icon" onclick="actions.deleteItem('goal', '${goal.id}')" style="color:#ef4444">${Icons.Trash}</button>
                </div>
            ` : '';

            return `
                <div class="card" ${!showActions ? 'style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; margin-bottom:0"' : ''}>
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:${showActions ? '20px' : '5px'}">
                        <div style="display:flex; gap:15px; align-items:center">
                            ${showActions ? `<div style="font-size:32px; background:#1e293b; width:60px; height:60px; display:flex; align-items:center; justify-content:center; border-radius:15px">${goal.icon}</div>` : ''}
                            <div>
                                <h3 style="${showActions ? 'font-size:18px' : 'font-weight:500'}">${!showActions ? goal.icon : ''} ${goal.title}</h3>
                                ${showActions ? `<div style="display:flex; align-items:center; gap:5px; font-size:13px; color:var(--text-muted); margin-top:4px">${Icons.Calendar} ${formatDate(goal.deadline)}</div>` : ''}
                            </div>
                        </div>
                        ${showActions ? actionsHtml : `<span style="font-size:12px; color:var(--text-muted)">${percent}%</span>`}
                    </div>
                    ${!showActions ? '' : `
                        <div style="margin-bottom:8px; display:flex; justify-content:space-between; font-size:14px">
                            <span style="color:var(--success)">ব্যালেন্স: ${formatCurrency(bal)}</span>
                            <span style="color:var(--text-muted)">বাকি: ${formatCurrency(remaining)}</span>
                        </div>
                    `}
                    <div class="progress-bar" style="${!showActions ? '' : 'height:12px'}">
                        <div class="progress-fill" style="width:${percent}%; display:flex; align-items:center; justify-content:flex-end; padding-right:5px">
                            ${showActions && percent > 10 ? `<span style="font-size:9px; font-weight:bold; color:white">${percent}%</span>` : ''}
                        </div>
                    </div>
                    <div style="text-align:${showActions ? 'right' : 'left'}; display:${showActions ? 'block' : 'flex'}; justify-content:space-between; font-size:${showActions ? '12px' : '11px'}; color:var(--text-muted); margin-top:5px">
                        ${!showActions ? `<span>বর্তমান: ${formatCurrency(bal)}</span>` : ''}
                        <span>লক্ষ্য: ${formatCurrency(goal.target)}</span>
                    </div>
                </div>
            `;
        }

        function renderTransactions() {
            const rows = state.transactions.map(t => renderTransactionRow(t, true)).join('');
            return `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px">
                    <h2>লেনদেনের ইতিহাস</h2>
                    <div style="position:relative; width:100%; max-width:300px">
                        <div style="position:absolute; left:10px; top:10px; color:var(--text-muted)">${Icons.Search}</div>
                        <input class="input-field" style="padding-left:35px" placeholder="খুঁজুন..." onkeyup="actions.filterTrans(this.value)" />
                    </div>
                </div>
                <div class="card" style="padding:0; overflow:hidden">
                    <div style="overflow-x:auto">
                        <table style="width:100%; border-collapse:collapse; min-width:600px">
                            <thead>
                                <tr style="background:#1e293b; text-align:left; font-size:12px; color:var(--text-muted); text-transform:uppercase">
                                    <th style="padding:15px">বিবরণ</th>
                                    <th style="padding:15px">অ্যাকাউন্ট</th>
                                    <th style="padding:15px">তারিখ</th>
                                    <th style="padding:15px; text-align:right">পরিমাণ</th>
                                    <th style="padding:15px; text-align:center">অ্যাকশন</th>
                                </tr>
                            </thead>
                            <tbody>${rows || '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted)">কোন লেনদেন নেই</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderTransactionRow(t, isTable = false) {
            const accName = state.accounts.find(a => a.id === t.accountId)?.name || 'N/A';
            const icon = `<div class="icon-box ${t.type === 'income' ? 'icon-income' : 'icon-expense'}" style="width:30px; height:30px">${t.type === 'income' ? Icons.Up : Icons.Down}</div>`;
            const amount = `<span style="font-weight:bold; color:${t.type === 'income' ? 'var(--success)' : 'var(--danger)'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</span>`;
            
            if (!isTable) {
                return `
                    <div class="transaction-item">
                        <div style="display:flex; gap:12px; align-items:center">
                            ${icon}
                            <div>
                                <div style="font-weight:500">${t.category}</div>
                                <div style="font-size:12px; color:var(--text-muted)">${formatDate(t.date)}</div>
                            </div>
                        </div>
                        ${amount}
                    </div>
                `;
            }

            return `
                <tr class="trans-row" data-search="${t.category} ${t.description}" style="border-bottom:1px solid var(--border)">
                    <td style="padding:15px">
                        <div style="display:flex; align-items:center; gap:10px">
                            ${icon}
                            <div>
                                <div style="font-weight:500">${t.category}</div>
                                <div style="font-size:12px; color:var(--text-muted)">${t.description}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding:15px"><span class="badge">${accName}</span></td>
                    <td style="padding:15px; color:var(--text-muted); font-size:14px">${formatDate(t.date)}</td>
                    <td style="padding:15px; text-align:right">${amount}</td>
                    <td style="padding:15px; text-align:center">
                        <button class="btn-icon" onclick="actions.deleteItem('trans', '${t.id}')" style="color:var(--text-muted)">${Icons.Trash}</button>
                    </td>
                </tr>
            `;
        }

        function renderModals() {
            if (!state.modals.active) return '';
            const { active, data } = state.modals;
            const title = active === 'transaction' ? 'নতুন লেনদেন' : active === 'account' ? (data ? 'অ্যাকাউন্ট এডিট' : 'নতুন অ্যাকাউন্ট') : (data ? 'গোল এডিট' : 'নতুন গোল');
            
            let content = '';
            if (active === 'transaction') {
                content = `
                    <form onsubmit="actions.saveTransaction(event)">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; background:#020617; padding:4px; border-radius:10px; margin-bottom:15px">
                            <button type="button" id="transTypeIncome" onclick="actions.toggleTransType('income')" style="border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:600; background:transparent; color:var(--text-muted)">আয়</button>
                            <button type="button" id="transTypeExpense" onclick="actions.toggleTransType('expense')" class="active" style="border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:600; background:var(--danger); color:white">ব্যয়</button>
                        </div>
                        <div class="input-group">
                            <label class="input-label">পরিমাণ (টাকা)</label>
                            <input name="amount" type="number" class="input-field" placeholder="0.00" required />
                        </div>
                        <div class="input-group">
                            <label class="input-label">অ্যাকাউন্ট</label>
                            <select name="accountId" class="input-field">
                                ${state.accounts.map(a => `<option value="${a.id}">${a.name} - ৳${a.balance}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid-2">
                            <div class="input-group">
                                <label class="input-label">ক্যাটাগরি</label>
                                <input name="category" class="input-field" placeholder="যেমন: খাবার" required />
                            </div>
                            <div class="input-group">
                                <label class="input-label">তারিখ</label>
                                <input name="date" type="date" class="input-field" value="${new Date().toISOString().split('T')[0]}" required />
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">বিবরণ</label>
                            <input name="description" class="input-field" />
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center">সেভ করুন</button>
                    </form>
                `;
            } else if (active === 'account') {
                content = `
                    <form onsubmit="actions.saveAccount(event)">
                        <div class="input-group">
                            <label class="input-label">নাম</label>
                            <input name="name" class="input-field" placeholder="ব্যাংকের নাম" value="${data?.name || ''}" required />
                        </div>
                        <div class="grid-2">
                            <div class="input-group">
                                <label class="input-label">টাইপ</label>
                                <select name="type" class="input-field">
                                    <option value="bank" ${data?.type === 'bank' ? 'selected' : ''}>ব্যাংক</option>
                                    <option value="cash" ${data?.type === 'cash' ? 'selected' : ''}>নগদ</option>
                                    <option value="mobile" ${data?.type === 'mobile' ? 'selected' : ''}>মোবাইল ওয়ালেট</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">ব্যালেন্স</label>
                                <input name="balance" type="number" class="input-field" value="${data?.balance || ''}" required />
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center">${data ? 'আপডেট' : 'তৈরি করুন'}</button>
                    </form>
                `;
            } else if (active === 'goal') {
                content = `
                    <form onsubmit="actions.saveGoal(event)">
                        <div class="grid-2" style="grid-template-columns:60px 1fr">
                            <div class="input-group">
                                <label class="input-label">আইকন</label>
                                <input name="icon" class="input-field" style="text-align:center; font-size:20px" value="${data?.icon || '🎯'}" />
                            </div>
                            <div class="input-group">
                                <label class="input-label">নাম</label>
                                <input name="title" class="input-field" value="${data?.title || ''}" required />
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">টার্গেট</label>
                            <input name="target" type="number" class="input-field" value="${data?.target || ''}" required />
                        </div>
                        <div class="input-group">
                            <label class="input-label">ডেডলাইন</label>
                            <input name="deadline" type="date" class="input-field" value="${data?.deadline || ''}" required />
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center">${data ? 'আপডেট' : 'সেট করুন'}</button>
                    </form>
                `;
            }

            return `
                <div class="modal-overlay open" onclick="actions.closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>${title}</h3>
                            <button class="btn-icon" onclick="actions.closeModal()">${Icons.Close}</button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize if key exists
        if(state.accessKey) {
            // Need to wait for Auth
            const checkAuth = setInterval(() => {
                if(state.isFirebaseReady) {
                    subscribeToData();
                    clearInterval(checkAuth);
                }
            }, 200);
        } else {
            // Render Login immediately if not waiting for data
            renderApp(); 
        }

    </script>
</body>
</html>