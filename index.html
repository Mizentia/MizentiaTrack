<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack BD</title>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS Variables & Reset --- */
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-glass: rgba(30, 41, 59, 0.7);
            --primary: #10b981;
            --primary-hover: #059669;
            --danger: #f43f5e;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --gradient-primary: linear-gradient(135deg, #10b981 0%, #0d9488 100%);
            --gradient-card: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* --- Utility Classes --- */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .hidden { display: none !important; }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .font-bold { font-weight: 700; }
        
        .text-primary { color: var(--primary); }
        .text-danger { color: var(--danger); }
        .text-muted { color: var(--text-muted); }

        /* --- Components --- */
        
        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .card:active { transform: scale(0.98); }
        
        /* Glass Effect for Dashboard Card */
        .hero-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            position: relative;
        }
        .hero-card::before {
            content: '';
            position: absolute;
            top: -50px; right: -50px;
            width: 150px; height: 150px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            filter: blur(40px);
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            color: white;
        }
        
        .btn-primary { background: var(--gradient-primary); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); }
        .btn-danger { background: var(--danger); }
        
        .btn:active { transform: scale(0.95); }

        .btn-icon-lg {
            flex-direction: column;
            padding: 16px;
            height: 100px;
            width: 100%;
        }

        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; color: var(--text-muted); font-size: 0.875rem; margin-bottom: 6px; }
        
        input, select, textarea {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 12px;
            outline: none;
            font-size: 1rem;
        }
        
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 10px;
            z-index: 100;
        }
        
        .nav-item {
            background: none;
            border: none;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            cursor: pointer;
            gap: 4px;
        }
        
        .nav-item.active { color: var(--primary); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: flex-end; /* Mobile bottom sheet style */
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: #1e293b;
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @media (min-width: 600px) {
            .modal-overlay { align-items: center; }
            .modal-content { border-radius: 24px; transform: translateY(20px); }
        }

        .modal-overlay.show .modal-content { transform: translateY(0); }

        /* Scrolling Lists */
        .scroll-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 12px;
            margin: 0 -16px 16px -16px;
            padding-left: 16px;
            padding-right: 16px;
        }
        .scroll-row::-webkit-scrollbar { display: none; }

        .account-card-mini {
            min-width: 160px;
            height: 100px;
            border-radius: 16px;
            padding: 12px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        /* Radio Group Style */
        .radio-group { display: flex; gap: 10px; }
        .radio-label {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            color: var(--text-muted);
            transition: 0.2s;
        }
        .radio-input:checked + .radio-label {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .radio-input:checked + .radio-label.expense {
            background: var(--danger);
            border-color: var(--danger);
        }
    </style>
</head>
<body>

    <!-- Top Bar -->
    <div class="container" style="padding-bottom: 0;">
        <div class="flex justify-between items-center" style="margin-bottom: 20px;">
            <div class="flex items-center gap-2" onclick="openProfileModal()">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); display: flex; items-center; justify-center; border: 2px solid var(--primary); overflow: hidden;">
                    <i data-lucide="user" style="margin: auto; color: var(--primary);"></i>
                </div>
                <div>
                    <h3 id="profile-name" class="font-bold text-main" style="line-height: 1.2;">ব্যবহারকারী</h3>
                    <span id="profile-title" class="text-xs text-primary">FinTrack মেম্বার</span>
                </div>
            </div>
            <div class="flex items-center gap-2" style="background: rgba(16, 185, 129, 0.1); padding: 4px 10px; border-radius: 20px;">
                <i data-lucide="wifi" size="14" class="text-primary"></i>
                <span class="text-xs font-bold text-primary">LIVE</span>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="app" class="container animate-fade">
        <!-- Dashboard View (Default) -->
        <div id="view-dashboard">
            <!-- Balance Card -->
            <div class="card hero-card">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-sm" style="opacity: 0.8;">মোট স্থিতি (Net Worth)</span>
                        <h1 class="text-xl" style="font-size: 2rem; font-weight: 700; margin-top: 4px;" id="total-balance">৳ ০.০০</h1>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 12px;">
                        <i data-lucide="wallet" color="white"></i>
                    </div>
                </div>
                <div class="flex gap-4" style="margin-top: 20px;">
                    <div style="background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 10px; flex: 1;">
                        <div class="flex items-center gap-1 text-primary" style="color: #6ee7b7; margin-bottom: 4px;">
                            <i data-lucide="trending-up" size="14"></i> <span class="text-xs">ইনকাম</span>
                        </div>
                        <span class="font-bold" id="total-income">৳ ০.০০</span>
                    </div>
                    <div style="background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 10px; flex: 1;">
                        <div class="flex items-center gap-1" style="color: #fda4af; margin-bottom: 4px;">
                            <i data-lucide="trending-down" size="14"></i> <span class="text-xs">খরচ</span>
                        </div>
                        <span class="font-bold" id="total-expense">৳ ০.০০</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex gap-2" style="margin-bottom: 24px;">
                <button class="btn btn-primary btn-icon-lg" onclick="openModal('modal-transaction')" style="flex: 2;">
                    <i data-lucide="plus-circle" size="24"></i>
                    <span>লেনদেন</span>
                </button>
                <button class="btn btn-secondary btn-icon-lg" onclick="openModal('modal-loan')" style="flex: 1;">
                    <i data-lucide="users" size="24" class="text-primary"></i>
                    <span>ঋণ</span>
                </button>
                <button class="btn btn-secondary btn-icon-lg" onclick="switchTab('accounts')" style="flex: 1;">
                    <i data-lucide="target" size="24" style="color: #a855f7;"></i>
                    <span>গোল</span>
                </button>
            </div>

            <!-- Accounts Section -->
            <div class="flex justify-between items-center" style="margin-bottom: 10px;">
                <h3 class="font-bold text-main">অ্যাকাউন্টস</h3>
                <span class="text-xs text-primary" onclick="switchTab('accounts')" style="cursor: pointer;">সব দেখুন</span>
            </div>
            <div class="scroll-row" id="accounts-list-home">
                <!-- Accounts will be injected here -->
                <div class="account-card-mini" style="background: #334155; align-items: center; justify-content: center; min-width: 100px;">
                    <span class="text-xs">Loading...</span>
                </div>
            </div>

            <!-- History Section -->
            <h3 class="font-bold text-main" style="margin-bottom: 10px;">সম্প্রতি লেনদেন</h3>
            <div id="recent-history-list">
                <!-- Transactions will be injected here -->
            </div>
        </div>

        <!-- Accounts View -->
        <div id="view-accounts" class="hidden">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h2 class="text-xl font-bold">অ্যাকাউন্ট ম্যানেজমেন্ট</h2>
                <button class="btn btn-primary" onclick="openAccountModal()">+ নতুন</button>
            </div>
            <div id="all-accounts-list" class="flex flex-col gap-2">
                <!-- Full list -->
            </div>
        </div>

        <!-- Loans View -->
        <div id="view-loans" class="hidden">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h2 class="text-xl font-bold">ঋণ ও পাওনা</h2>
                <button class="btn btn-primary" onclick="openModal('modal-loan')">+ নতুন</button>
            </div>
            <div class="flex gap-2" style="margin-bottom: 20px;">
                <div class="card" style="flex:1; border-left: 4px solid var(--primary); margin:0;">
                    <span class="text-xs text-muted">পাবো (Receivable)</span>
                    <h3 class="text-lg font-bold text-primary" id="loan-given-total">৳ ০</h3>
                </div>
                <div class="card" style="flex:1; border-left: 4px solid var(--danger); margin:0;">
                    <span class="text-xs text-muted">দিবো (Payable)</span>
                    <h3 class="text-lg font-bold text-danger" id="loan-taken-total">৳ ০</h3>
                </div>
            </div>
            <div id="loans-list" class="flex flex-col gap-2"></div>
        </div>
        
        <!-- History View -->
        <div id="view-history" class="hidden">
             <h2 class="text-xl font-bold" style="margin-bottom: 20px;">লেনদেনের ইতিহাস</h2>
             <div id="full-history-list" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('dashboard')" id="nav-dashboard">
            <i data-lucide="layout-dashboard" size="20"></i>
            <span>হোম</span>
        </button>
        <button class="nav-item" onclick="switchTab('accounts')" id="nav-accounts">
            <i data-lucide="wallet" size="20"></i>
            <span>অ্যাকাউন্টস</span>
        </button>
        <button class="nav-item" onclick="switchTab('loans')" id="nav-loans">
            <i data-lucide="users" size="20"></i>
            <span>ঋণ</span>
        </button>
        <button class="nav-item" onclick="switchTab('history')" id="nav-history">
            <i data-lucide="history" size="20"></i>
            <span>হিস্ট্রি</span>
        </button>
    </div>

    <!-- MODALS -->

    <!-- Transaction Modal -->
    <div id="modal-transaction" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 class="text-xl font-bold">নতুন লেনদেন</h3>
                <button onclick="closeModal('modal-transaction')" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
            </div>
            <form id="form-transaction">
                <div class="input-group radio-group">
                    <input type="radio" id="type-expense" name="type" value="expense" class="radio-input hidden" checked onchange="updateCategoryOptions()">
                    <label for="type-expense" class="radio-label expense">খরচ</label>
                    
                    <input type="radio" id="type-income" name="type" value="income" class="radio-input hidden" onchange="updateCategoryOptions()">
                    <label for="type-income" class="radio-label">আয়</label>
                </div>
                <div class="input-group">
                    <label class="input-label">পরিমাণ</label>
                    <input type="number" name="amount" placeholder="0.00" required>
                </div>
                <div class="input-group">
                    <label class="input-label">খাত / ক্যাটাগরি</label>
                    <select name="category" id="transaction-category">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">অ্যাকাউন্ট</label>
                    <select name="accountId" id="transaction-account" required>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">নোট</label>
                    <textarea name="note" rows="2" placeholder="বিস্তারিত..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">সেভ করুন</button>
            </form>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="modal-account" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 class="text-xl font-bold" id="account-modal-title">অ্যাকাউন্ট ম্যানেজ</h3>
                <button onclick="closeModal('modal-account')" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
            </div>
            <form id="form-account">
                <input type="hidden" name="id" id="account-id">
                <div class="input-group">
                    <label class="input-label">নাম</label>
                    <input type="text" name="name" id="account-name" placeholder="যেমন: ব্যাংক এশিয়া" required>
                </div>
                <div class="input-group">
                    <label class="input-label">ধরন</label>
                    <select name="type" id="account-type">
                        <option value="bank">ব্যাংক</option>
                        <option value="mobile">মোবাইল ব্যাংকিং</option>
                        <option value="cash">নগদ টাকা</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">বর্তমান ব্যালেন্স</label>
                    <input type="number" name="balance" id="account-balance" required>
                </div>
                <div class="input-group">
                    <label class="input-label">রঙ নির্বাচন করুন</label>
                    <select name="color" id="account-color">
                        <option value="linear-gradient(135deg, #6366f1, #4f46e5)">নীল (Blue)</option>
                        <option value="linear-gradient(135deg, #10b981, #059669)">সবুজ (Emerald)</option>
                        <option value="linear-gradient(135deg, #f59e0b, #d97706)">কমলা (Orange)</option>
                        <option value="linear-gradient(135deg, #ec4899, #db2777)">গোলাপি (Pink)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">সেভ করুন</button>
                <button type="button" id="btn-delete-account" class="btn btn-danger hidden" style="width: 100%; margin-top: 10px;">ডিলিট করুন</button>
            </form>
        </div>
    </div>

    <!-- Loan Modal -->
    <div id="modal-loan" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 class="text-xl font-bold">ঋণ / পাওনা</h3>
                <button onclick="closeModal('modal-loan')" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
            </div>
            <form id="form-loan">
                <div class="input-group radio-group">
                    <input type="radio" id="loan-given" name="type" value="given" class="radio-input hidden" checked>
                    <label for="loan-given" class="radio-label">পাবো</label>
                    
                    <input type="radio" id="loan-taken" name="type" value="taken" class="radio-input hidden">
                    <label for="loan-taken" class="radio-label expense">দিবো</label>
                </div>
                <div class="input-group">
                    <label class="input-label">ব্যক্তির নাম</label>
                    <input type="text" name="person" required>
                </div>
                <div class="input-group">
                    <label class="input-label">পরিমাণ</label>
                    <input type="number" name="amount" required>
                </div>
                <div class="input-group">
                    <label class="input-label">তারিখ</label>
                    <input type="date" name="date" id="loan-date" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">সেভ করুন</button>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="modal-profile" class="modal-overlay">
        <div class="modal-content">
             <div class="flex justify-between items-center" style="margin-bottom: 20px;">
                <h3 class="text-xl font-bold">প্রোফাইল সেটিংস</h3>
                <button onclick="closeModal('modal-profile')" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
            </div>
            <form id="form-profile">
                <div class="input-group">
                    <label class="input-label">আপনার নাম</label>
                    <input type="text" name="name" id="input-profile-name" required>
                </div>
                <div class="input-group">
                    <label class="input-label">উপাধি / টাইটেল</label>
                    <input type="text" name="title" id="input-profile-title" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">আপডেট করুন</button>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        // Prioritize global environment config if available (fixes custom token mismatch)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyAO7EN4wU33v028vd9pelSyhGibSNGQLU0",
                authDomain: "mizentiatrack.firebaseapp.com",
                projectId: "mizentiatrack",
                storageBucket: "mizentiatrack.firebasestorage.app",
                messagingSenderId: "1009510331718",
                appId: "1:1009510331718:web:e8cb1f5acd04a6a5aca147"
            };
        }
        
        // --- Init Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let accounts = [];
        let transactions = [];
        let loans = [];

        // --- Auth & Sync ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    throw new Error("No custom token available");
                }
            } catch (error) {
                console.warn("Authentication failed with custom token, falling back to anonymous auth:", error);
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                setupRealtimeListeners(user.uid);
            }
        });

        function setupRealtimeListeners(uid) {
            const basePath = `artifacts/${appId}/users/${uid}`;
            
            // Profile
            onSnapshot(doc(db, basePath, 'profile', 'info'), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    document.getElementById('profile-name').innerText = data.name || 'ব্যবহারকারী';
                    document.getElementById('profile-title').innerText = data.title || 'FinTrack মেম্বার';
                    document.getElementById('input-profile-name').value = data.name || '';
                    document.getElementById('input-profile-title').value = data.title || '';
                }
            });

            // Accounts
            onSnapshot(collection(db, basePath, 'accounts'), (snap) => {
                accounts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateDashboard();
                renderAccounts();
            });

            // Transactions
            onSnapshot(collection(db, basePath, 'transactions'), (snap) => {
                transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateDashboard();
                renderHistory();
            });

            // Loans
            onSnapshot(collection(db, basePath, 'loans'), (snap) => {
                loans = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderLoans();
            });
        }

        // --- Render Functions ---

        function formatCurrency(amount) {
            return new Intl.NumberFormat('bn-BD', { style: 'currency', currency: 'BDT' }).format(amount || 0);
        }

        function updateDashboard() {
            // Calculate Totals
            const totalBalance = accounts.reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

            document.getElementById('total-balance').innerText = formatCurrency(totalBalance);
            document.getElementById('total-income').innerText = formatCurrency(totalIncome);
            document.getElementById('total-expense').innerText = formatCurrency(totalExpense);

            // Populate Account Dropdown in Transaction Modal
            const select = document.getElementById('transaction-account');
            select.innerHTML = accounts.map(acc => `<option value="${acc.id}">${acc.name} (${formatCurrency(acc.balance)})</option>`).join('');
            
            if(accounts.length === 0) select.innerHTML = '<option disabled selected>আগে অ্যাকাউন্ট তৈরি করুন</option>';
        }

        function renderAccounts() {
            const homeList = document.getElementById('accounts-list-home');
            const fullList = document.getElementById('all-accounts-list');

            if(accounts.length === 0) {
                homeList.innerHTML = `<div class="text-muted text-sm p-4">কোন অ্যাকাউন্ট নেই</div>`;
                fullList.innerHTML = `<div class="text-center text-muted p-4">কোন অ্যাকাউন্ট পাওয়া যায়নি। নতুন যুক্ত করুন।</div>`;
                return;
            }

            // Horizontal Scroll List (Home)
            homeList.innerHTML = accounts.map(acc => `
                <div class="account-card-mini" style="background: ${acc.color}; box-shadow: 0 4px 10px rgba(0,0,0,0.3);" onclick="editAccount('${acc.id}')">
                    <div class="flex justify-between items-start">
                        <i data-lucide="${acc.type === 'bank' ? 'briefcase' : 'wallet'}" size="18" style="opacity:0.8;"></i>
                        <span style="background:rgba(0,0,0,0.2); padding:2px 6px; border-radius:8px; font-size:10px; text-transform:uppercase;">${acc.type}</span>
                    </div>
                    <div>
                        <div class="text-xs" style="opacity:0.9;">${acc.name}</div>
                        <div class="font-bold text-lg">${formatCurrency(acc.balance)}</div>
                    </div>
                </div>
            `).join('');

            // Vertical Full List
            fullList.innerHTML = accounts.map(acc => `
                <div class="card flex justify-between items-center" style="margin-bottom:8px; cursor:pointer;" onclick="editAccount('${acc.id}')">
                    <div class="flex items-center gap-2">
                        <div style="width:40px; height:40px; border-radius:10px; background:${acc.color}; display:flex; align-items:center; justify-content:center; color:white;">
                             <i data-lucide="${acc.type === 'bank' ? 'briefcase' : 'wallet'}" size="20"></i>
                        </div>
                        <div>
                            <div class="font-bold">${acc.name}</div>
                            <div class="text-xs text-muted capitalize">${acc.type}</div>
                        </div>
                    </div>
                    <div class="font-bold text-primary">${formatCurrency(acc.balance)}</div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function renderHistory() {
            const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            const listHtml = sorted.length ? sorted.map(t => {
                const isIncome = t.type === 'income';
                return `
                <div class="card flex justify-between items-center" style="padding: 12px; margin-bottom: 8px;">
                    <div class="flex items-center gap-2">
                         <div style="padding: 8px; border-radius: 50%; background: ${isIncome ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)'}; color: ${isIncome ? '#10b981' : '#f43f5e'};">
                            <i data-lucide="${isIncome ? 'trending-up' : 'trending-down'}" size="16"></i>
                         </div>
                         <div>
                            <div class="font-bold text-sm">${t.category}</div>
                            <div class="text-xs text-muted">${new Date(t.date).toLocaleDateString()}</div>
                         </div>
                    </div>
                    <div class="font-bold ${isIncome ? 'text-primary' : 'text-danger'}">
                        ${isIncome ? '+' : '-'} ${formatCurrency(t.amount)}
                    </div>
                </div>`;
            }).join('') : '<div class="text-muted text-center text-sm p-4">কোন লেনদেনের ইতিহাস নেই</div>';

            document.getElementById('recent-history-list').innerHTML = listHtml; // Shows all or limit in JS
            document.getElementById('full-history-list').innerHTML = listHtml;
            lucide.createIcons();
        }

        function renderLoans() {
            const given = loans.filter(l => l.type === 'given' && !l.isSettled).reduce((sum, l) => sum + parseFloat(l.amount), 0);
            const taken = loans.filter(l => l.type === 'taken' && !l.isSettled).reduce((sum, l) => sum + parseFloat(l.amount), 0);
            
            document.getElementById('loan-given-total').innerText = formatCurrency(given);
            document.getElementById('loan-taken-total').innerText = formatCurrency(taken);

            document.getElementById('loans-list').innerHTML = loans.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(l => `
                <div class="card" style="margin-bottom: 8px; border-left: 4px solid ${l.type === 'given' ? 'var(--primary)' : 'var(--danger)'}; opacity: ${l.isSettled ? '0.5' : '1'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-lg">${l.person}</div>
                            <div class="text-xs text-muted">${new Date(l.date).toLocaleDateString()}</div>
                        </div>
                        <div class="text-right">
                             <div class="font-bold ${l.type === 'given' ? 'text-primary' : 'text-danger'}">
                                ${l.type === 'given' ? 'পাবো' : 'দিবো'} ${formatCurrency(l.amount)}
                             </div>
                             ${!l.isSettled ? `<button onclick="settleLoan('${l.id}')" style="margin-top:4px; font-size:10px; color:#22d3ee; background:none; border:none; cursor:pointer;">সেটেল্ড মার্ক করুন</button>` : '<span class="text-xs text-primary">পরিশোধিত</span>'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- Event Handlers (Exposed to Window) ---

        window.openModal = (id) => {
            document.getElementById(id).classList.add('show');
            if(id === 'modal-loan') document.getElementById('loan-date').valueAsDate = new Date();
        };
        
        window.closeModal = (id) => document.getElementById(id).classList.remove('show');
        
        window.openProfileModal = () => window.openModal('modal-profile');

        window.openAccountModal = () => {
            // Reset form
            document.getElementById('form-account').reset();
            document.getElementById('account-id').value = '';
            document.getElementById('account-modal-title').innerText = 'নতুন অ্যাকাউন্ট';
            document.getElementById('btn-delete-account').classList.add('hidden');
            window.openModal('modal-account');
        };

        window.editAccount = (id) => {
            const acc = accounts.find(a => a.id === id);
            if(!acc) return;
            
            document.getElementById('account-id').value = acc.id;
            document.getElementById('account-name').value = acc.name;
            document.getElementById('account-type').value = acc.type;
            document.getElementById('account-balance').value = acc.balance;
            document.getElementById('account-color').value = acc.color;
            
            document.getElementById('account-modal-title').innerText = 'এডিট অ্যাকাউন্ট';
            
            // Delete Button Setup
            const btnDelete = document.getElementById('btn-delete-account');
            btnDelete.classList.remove('hidden');
            btnDelete.onclick = async () => {
                if(confirm('মুছে ফেলতে চান?')) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, 'accounts', id));
                    window.closeModal('modal-account');
                }
            };

            window.openModal('modal-account');
        };

        window.switchTab = (tabName) => {
            // Hide all views
            ['dashboard', 'accounts', 'loans', 'history'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
            });
            // Show active
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`nav-${tabName}`).classList.add('active');
            window.scrollTo(0,0);
        };

        window.updateCategoryOptions = () => {
            const type = document.querySelector('input[name="type"]:checked').value;
            const select = document.getElementById('transaction-category');
            if (type === 'expense') {
                select.innerHTML = `
                    <option value="বাজার খরচ">বাজার খরচ</option>
                    <option value="যাতায়াত">যাতায়াত</option>
                    <option value="মোবাইল রিচার্জ">মোবাইল রিচার্জ</option>
                    <option value="পরিবার">পরিবারকে দেওয়া</option>
                    <option value="অন্যান্য">অন্যান্য</option>
                `;
            } else {
                 select.innerHTML = `
                    <option value="দৈনিক আয়">দৈনিক আয় (Salary/Wages)</option>
                    <option value="ব্যবসায়িক লাভ">ব্যবসায়িক লাভ</option>
                    <option value="উপহার">উপহার / গিফট</option>
                    <option value="অন্যান্য">অন্যান্য</option>
                `;
            }
        };
        // Init categories
        window.updateCategoryOptions();

        window.settleLoan = async (id) => {
            if(confirm('এই লেনদেনটি সম্পন্ন হয়েছে?')) {
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, 'loans', id), { isSettled: true });
            }
        };

        // --- Form Submissions ---

        document.getElementById('form-transaction').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const amount = parseFloat(fd.get('amount'));
            const type = fd.get('type');
            const accountId = fd.get('accountId');

            if(!accountId) { alert('অ্যাকাউন্ট সিলেক্ট করুন'); return; }

            // Add Transaction
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}`, 'transactions'), {
                amount, type, category: fd.get('category'), accountId,
                note: fd.get('note'), date: new Date().toISOString(), timestamp: new Date().toISOString()
            });

            // Update Account Balance
            const acc = accounts.find(a => a.id === accountId);
            if(acc) {
                const newBal = type === 'income' ? parseFloat(acc.balance) + amount : parseFloat(acc.balance) - amount;
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, 'accounts', accountId), { balance: newBal });
            }

            e.target.reset();
            window.closeModal('modal-transaction');
        });

        document.getElementById('form-account').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = fd.get('id');
            const data = {
                name: fd.get('name'),
                type: fd.get('type'),
                balance: parseFloat(fd.get('balance')),
                color: fd.get('color')
            };

            if(id) {
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, 'accounts', id), data);
            } else {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}`, 'accounts'), data);
            }
            window.closeModal('modal-account');
        });

        document.getElementById('form-loan').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}`, 'loans'), {
                person: fd.get('person'),
                amount: parseFloat(fd.get('amount')),
                type: fd.get('type'),
                date: fd.get('date'),
                isSettled: false
            });
            e.target.reset();
            window.closeModal('modal-loan');
        });

        document.getElementById('form-profile').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            await setDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}`, 'profile', 'info'), {
                name: fd.get('name'),
                title: fd.get('title')
            });
            window.closeModal('modal-profile');
        });

        // Initialize Icons
        lucide.createIcons();
    </script>
</body>
</html>